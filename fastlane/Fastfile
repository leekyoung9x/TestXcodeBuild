default_platform(:ios)

# ðŸ”¥ Äá»‹nh nghÄ©a biáº¿n GLOBAL
KEYCHAIN_NAME = "fastlane_tmp.keychain"
KEYCHAIN_PASSWORD = ENV["KEYCHAIN_PASSWORD"] || "1234"
KEYCHAIN_PATH = "~/Library/Keychains/#{KEYCHAIN_NAME}-db"

TARGET_NAME = "Unity-iPhone"
SCHEME_NAME = "Unity-iPhone"
APP_NAME = "Hat Second"
APP_IDENTIFIER = "com.newworld.gods"
TEAM_ID = "6VLL82FXHY"

APPLE_KEY_ID = "F2FJR735SW"
APPLE_ISSUER_ID = "c25c9a94-3764-4ecf-b9d8-63408ce4989d"
APPLE_KEY_PATH = "./fastlane/AuthKey_#{APPLE_KEY_ID}.p8"

VERSION_NUMBER = "1.0.0"  # ðŸ”¢ Äáº·t phiÃªn báº£n á»©ng dá»¥ng
BUILD_NUMBER = "4.0.2"    # ðŸ”¢ Äáº·t build number

platform :ios do
  desc "Setup Keychain for CI/CD"
  lane :setup_keychain do
    UI.message("ðŸ” Setting up keychain: #{KEYCHAIN_NAME}")

    # Kiá»ƒm tra náº¿u keychain Ä‘Ã£ tá»“n táº¡i
    keychain_exists = File.exist?(File.expand_path(KEYCHAIN_PATH))

    if keychain_exists
      UI.message("âœ… Keychain Ä‘Ã£ tá»“n táº¡i, khÃ´ng cáº§n táº¡o láº¡i: #{KEYCHAIN_NAME}")
    else
      # Táº¡o keychain má»›i náº¿u chÆ°a tá»“n táº¡i
      UI.message("ðŸ”„ Táº¡o má»›i keychain: #{KEYCHAIN_NAME}")
      sh "security create-keychain -p \"#{KEYCHAIN_PASSWORD}\" #{KEYCHAIN_NAME}"
    end

    # Má»Ÿ khÃ³a keychain
    sh "security unlock-keychain -p \"#{KEYCHAIN_PASSWORD}\" #{KEYCHAIN_NAME}"
    sh "security set-keychain-settings -t 3600 -u #{KEYCHAIN_NAME}" # Giá»¯ keychain má»Ÿ trong 1h
    sh "security list-keychains -s #{KEYCHAIN_NAME}" # Äáº£m báº£o keychain cÃ³ trong danh sÃ¡ch Ä‘Æ°á»£c sá»­ dá»¥ng
    sh "security find-identity -v -p codesigning" # Debug kiá»ƒm tra certificate

    # Äáº£m báº£o keychain cÃ³ trong danh sÃ¡ch keychain Ä‘Æ°á»£c sá»­ dá»¥ng
    sh "security list-keychains -s #{KEYCHAIN_NAME}"

    UI.message("âœ… Keychain setup completed: #{KEYCHAIN_NAME}")
  end

  desc "Archive vÃ  Push lÃªn TestFlight"
  lane :beta do
    # Setup Keychain trÆ°á»›c khi báº¯t Ä‘áº§u
    setup_keychain

    # ðŸ”¥ Äáº·t biáº¿n mÃ´i trÆ°á»ng cho Match
    ENV["MATCH_PASSWORD"] ||= "hihi"
    ENV["MATCH_KEYCHAIN_PASSWORD"] ||= KEYCHAIN_PASSWORD

    # âœ… Cáº­p nháº­t version vÃ  build number theo biáº¿n Global
    increment_version_number(
      version_number: VERSION_NUMBER,
      xcodeproj: "./#{SCHEME_NAME}.xcodeproj"
    )

    increment_build_number(
      build_number: BUILD_NUMBER,
      xcodeproj: "./#{SCHEME_NAME}.xcodeproj"
    )

    UI.message("ðŸ“¢ Äang chuáº©n bá»‹ archive: #{APP_NAME}")
    UI.message("âœ… PhiÃªn báº£n: #{VERSION_NUMBER} (#{BUILD_NUMBER})")

    # âœ… Thiáº¿t láº­p API Key tá»« Apple
    api_key = app_store_connect_api_key(
      key_id: APPLE_KEY_ID,
      issuer_id: APPLE_ISSUER_ID,
      key_filepath: APPLE_KEY_PATH,
      duration: 1200,
      in_house: false
    )

    # âœ… Láº¥y provisioning profile Ä‘Ãºng cho cáº£ UnityFramework vÃ  Unity-iPhone
    match(
      type: "appstore",
      app_identifier: APP_IDENTIFIER,
      api_key: api_key,
      team_id: TEAM_ID,
      keychain_name: KEYCHAIN_NAME,
      readonly: false
    )

    # ðŸ”¥ Cáº­p nháº­t cho Unity-iPhone (Target chÃ­nh)
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "./#{SCHEME_NAME}.xcodeproj",
      targets: ["Unity-iPhone"],
      team_id: TEAM_ID,
      code_sign_identity: "Apple Distribution",
      profile_name: "match AppStore #{APP_IDENTIFIER}"
    )

    # âœ… Kiá»ƒm tra file cÃ³ tá»“n táº¡i trÆ°á»›c khi chmod
    if File.exist?("process_symbols.sh")
      sh "chmod +x process_symbols.sh"
    else
      UI.error("âš ï¸ File process_symbols.sh khÃ´ng tá»“n táº¡i!")
    end
  
    if File.exist?("process_symbols_il2cpp.sh")
      sh "chmod +x process_symbols_il2cpp.sh"
    else
      UI.error("âš ï¸ File process_symbols_il2cpp.sh khÃ´ng tá»“n táº¡i!")
    end

    # âœ… Táº¯t Gatekeeper trÆ°á»›c khi archive
    UI.message("ðŸ›‘ Táº¯t Gatekeeper Ä‘á»ƒ cho phÃ©p má»Ÿ á»©ng dá»¥ng tá»« má»i nguá»“n")
    sh "sudo spctl --master-disable"

    # ðŸ”¥ Archive Project Xcode
    gym(
      scheme: SCHEME_NAME,
      clean: true,
      output_directory: "./build",
      output_name: "#{APP_NAME}.ipa",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "#{APP_IDENTIFIER}" => "match AppStore #{APP_IDENTIFIER}"
        },
        signingStyle: "manual",
        teamID: "#{TEAM_ID}",
        compileBitcode: false,
        signingCertificate: "Apple Distribution"
      },
      xcargs: "DEVELOPMENT_TEAM=#{TEAM_ID} -allowProvisioningUpdates",
      suppress_xcode_output: false # Hiá»ƒn thá»‹ log chi tiáº¿t trong console
    )
    
    # âœ… Upload lÃªn TestFlight
    upload_to_testflight(
      api_key: api_key,
      app_identifier: APP_IDENTIFIER
    )

    UI.success("ðŸŽ‰ á»¨ng dá»¥ng #{APP_NAME} (#{VERSION_NUMBER} - Build #{BUILD_NUMBER}) Ä‘Ã£ Ä‘Æ°á»£c Archive vÃ  Ä‘áº©y lÃªn TestFlight thÃ nh cÃ´ng!")
  end
end
